<div class="section-management-container">
  <div class="management-card shadow-lg">
    <div class="card-header bg-primary text-white">
      <div class="header-content">
        <h5 class="title">
          <fa-icon [icon]="icons.layers" class="me-2"></fa-icon>
          {{ 'MANAGE_SECTIONS.TITLE' | translate }}
        </h5>
        <div class="controls">
          <button class="btn btn-light btn-add" (click)="openAddModal()">
            <fa-icon [icon]="icons.plus" class="me-2"></fa-icon>
            {{ 'MANAGE_SECTIONS.ACTIONS.ADD_NEW' | translate }}
          </button>
        </div>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="section-table table table-hover mb-0">
          <thead class="table-header">
            <tr>
              <th width="80px" class="ps-4">ID</th>
              <th>{{ 'MANAGE_SECTIONS.LABELS.NAME' | translate }}</th>
              <th width="150px">{{ 'MANAGE_SECTIONS.LABELS.VIEW_TYPE' | translate }}</th>
              <th width="100px">{{ 'MANAGE_SECTIONS.LABELS.ORDER' | translate }}</th>
              <th width="120px">{{ 'MANAGE_SECTIONS.LABELS.STATUS' | translate }}</th>
              <th width="150px">{{ 'MANAGE_SECTIONS.LABELS.CREATED' | translate }}</th>
              <th width="150px" class="pe-4 text-end">{{ 'MANAGE_SECTIONS.LABELS.ACTIONS' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let section of state.filteredSections" 
                [class.table-primary]="section.IsHomePage">
              <td class="id-cell ps-4">{{section.Id}}</td>
              <td class="title-cell">
                <div class="title-content d-flex align-items-center">
                  <span class="main-title fw-semibold">{{section.Name}}</span>
                  <span *ngIf="section.Contents?.length" class="badge bg-secondary ms-2">
                    {{ section.Contents.length }} {{ 'MANAGE_SECTIONS.LABELS.CONTENTS' | translate | lowercase }}
                  </span>
                </div>
              </td>
              <td class="type-cell">
                <span class="badge bg-light text-dark border">
                  {{ section.ViewType }}
                </span>
                <div class="badges-group mt-1">
                  <span *ngIf="section.IsHomePage" class="badge bg-info me-1">
                    {{ 'MANAGE_SECTIONS.STATUS.HOME' | translate }}
                  </span>
                  <span *ngIf="section.IsMenu" class="badge bg-warning text-dark me-1">
                    {{ 'MANAGE_SECTIONS.STATUS.MENU' | translate }}
                  </span>
                  <span *ngIf="section.IsFooter" class="badge bg-dark">
                    {{ 'MANAGE_SECTIONS.STATUS.FOOTER' | translate }}
                  </span>
                </div>
              </td>
              <td class="order-cell">{{section.Indx}}</td>
              <td class="status-cell">
                <span class="badge bg-success">{{ 'MANAGE_SECTIONS.LABELS.ACTIVE' | translate }}</span>
              </td>
              <td class="date-cell">{{section.CreatedAt | date:'shortDate'}}</td>
             <!-- تحديث جزء أزرار الحذف في القالب -->
<td class="actions-cell pe-4 text-end">
    <div class="btn-group btn-group-sm">
        <button class="btn btn-outline-primary rounded-start" 
                (click)="openEditModal(section)"
                [title]="'MANAGE_SECTIONS.ACTIONS.EDIT' | translate">
            <fa-icon [icon]="icons.edit"></fa-icon>
        </button>
        <button class="btn btn-outline-danger rounded-end" 
                (click)="deleteSection(section.Id)"
                [title]="'MANAGE_SECTIONS.ACTIONS.DELETE' | translate">
            <fa-icon [icon]="icons.trash"></fa-icon>
        </button>
    </div>
</td>
            </tr>
          </tbody>
        </table>
        
        <div *ngIf="state.filteredSections.length === 0" class="empty-state text-center py-5">
          <div class="empty-content">
            <fa-icon [icon]="icons.layers" class="empty-icon fs-1 text-muted mb-3"></fa-icon>
            <h5 class="text-muted">{{ 'MANAGE_SECTIONS.MESSAGES.NO_SECTIONS_FOUND' | translate }}</h5>
            <button class="btn btn-primary mt-3" (click)="openAddModal()">
              <fa-icon [icon]="icons.plus" class="me-2"></fa-icon>
              {{ 'MANAGE_SECTIONS.ACTIONS.ADD_NEW' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/Add Modal -->
  <app-modal [isOpen]="state.showModal" (close)="closeModal()" modalClass="section-modal">
    <div class="modal-header bg-light">
      <h5 class="modal-title">
        <fa-icon [icon]="state.isEditing ? icons.edit : icons.plus" class="me-2"></fa-icon>
        {{ (state.isEditing ? 'MANAGE_SECTIONS.ACTIONS.EDIT' : 'MANAGE_SECTIONS.ACTIONS.ADD') | translate }} 
        {{ 'MANAGE_SECTIONS.LABELS.SECTION' | translate }}
      </h5>
      <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
    </div>
    
    <div class="modal-body p-0">
      <ul class="nav nav-tabs nav-justified mb-0">
        <li class="nav-item" *ngFor="let tab of tabs">
          <a class="nav-link py-3" [class.active]="state.currentTab === tab.Id"
             (click)="state.currentTab = tab.Id">
            <fa-icon [icon]="getTabIcon(tab.Id)" class="me-2"></fa-icon>
            {{ tab.label | translate }}
          </a>
        </li>
      </ul>

      <form (ngSubmit)="createSection(sectionForm)" #sectionForm="ngForm" class="p-4">
        <!-- Basic Info Tab -->
        <div *ngIf="state.currentTab === 'info'" class="tab-content">
          <div class="row g-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold">{{ 'MANAGE_SECTIONS.LABELS.NAME' | translate }}*</label>
              <input type="text" class="form-control form-control-lg" 
                    [(ngModel)]="state.currentSection.Name" name="sectionName" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-semibold">{{ 'MANAGE_SECTIONS.LABELS.VIEW_TYPE' | translate }}*</label>
              <select class="form-select form-select-lg" 
                      [(ngModel)]="state.currentSection.ViewType" 
                      name="viewType" required>
                <option *ngFor="let type of ViewTypes" [value]="type">
                  {{ type }}
                </option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label class="form-label fw-semibold">{{ 'MANAGE_SECTIONS.LABELS.ORDER' | translate }}*</label>
              <input type="number" class="form-control form-control-lg" 
                    [(ngModel)]="state.currentSection.Indx" name="sectionIndex" required min="0">
            </div>
            
            <div class="col-md-6" *ngIf="languages && languages.length > 0">
              <label class="form-label fw-semibold">{{ 'MANAGE_SECTIONS.LABELS.LANGUAGE' | translate }}</label>
              <select class="form-select form-select-lg" 
                      [(ngModel)]="state.currentSection.LanguageId" 
                      name="languageId">
                <option [ngValue]="null">{{ 'MANAGE_SECTIONS.LABELS.DEFAULT_LANGUAGE' | translate }}</option>
                <option *ngFor="let lang of languages" [ngValue]="lang.Id">
                  {{ lang.Name }}
                </option>
              </select>
            </div>
            
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title mb-3">{{ 'MANAGE_SECTIONS.LABELS.STATUS' | translate }}</h6>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="IsMenuSwitch" 
                              [(ngModel)]="state.currentSection.IsMenu" name="isMenu">
                        <label class="form-check-label fw-medium" for="IsMenuSwitch">
                          {{ 'MANAGE_SECTIONS.LABELS.MENU_SECTION' | translate }}
                        </label>
                      </div>
                    </div>
                    
                    <div class="col-md-4">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="IsHomePageSwitch" 
                              [(ngModel)]="state.currentSection.IsHomePage" name="isHomePage">
                        <label class="form-check-label fw-medium" for="IsHomePageSwitch">
                          {{ 'MANAGE_SECTIONS.LABELS.HOMEPAGE_SECTION' | translate }}
                        </label>
                      </div>
                    </div>
                    
                    <div class="col-md-4">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="IsFooterSwitch" 
                              [(ngModel)]="state.currentSection.IsFooter" name="isFooter">
                        <label class="form-check-label fw-medium" for="IsFooterSwitch">
                          {{ 'MANAGE_SECTIONS.LABELS.FOOTER_SECTION' | translate }}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Tab -->
        <div *ngIf="state.currentTab === 'content'" class="tab-content">
          <div class="content-management row g-4">
            <div class="content-list col-md-5">
              <h6 class="mb-3 fw-semibold">{{ 'MANAGE_SECTIONS.LABELS.CONTENTS' | translate }}</h6>
              
              <div *ngIf="!state.currentSection.Contents?.length" class="alert alert-info">
                {{ 'MANAGE_SECTIONS.MESSAGES.NO_CONTENTS_FOUND' | translate }}
              </div>
              
              <div class="content-items-container" style="max-height: 400px; overflow-y: auto;">
                <div *ngFor="let content of state.currentSection.Contents" 
                     class="content-item card mb-2">
                  <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <h6 class="mb-1 fw-semibold">{{ content.Subject }}</h6>
                        <p class="small text-muted mb-2">{{ content.Content | truncate:50 }}</p>
                        <div *ngIf="content.Image" class="mt-2">
                          <img [src]="getFullFileUrl(content.Image)" class="img-thumbnail" style="max-height: 50px;">
                        </div>
                      </div>
                      <div class="btn-group ms-2">
                        <button class="btn btn-sm btn-outline-primary" (click)="editContent(content)">
                          <fa-icon [icon]="icons.edit"></fa-icon>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" (click)="deleteContent(content.Id)">
                          <fa-icon [icon]="icons.trash"></fa-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <button class="btn btn-outline-primary w-100 mt-3" (click)="addNewContent()">
                <fa-icon [icon]="icons.plus" class="me-2"></fa-icon>
                {{ 'MANAGE_SECTIONS.ACTIONS.ADD_CONTENT' | translate }}
              </button>
            </div>

            <div class="content-editor col-md-7" *ngIf="state.currentContent">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="mb-3 fw-semibold">
                    {{ state.currentContent.Id ? ('MANAGE_SECTIONS.ACTIONS.EDIT_CONTENT' | translate) : 
                       ('MANAGE_SECTIONS.ACTIONS.ADD_CONTENT' | translate) }}
                  </h6>
                  
                  <div class="mb-3">
                    <label class="form-label fw-medium">{{ 'MANAGE_SECTIONS.LABELS.SUBJECT' | translate }}*</label>
                    <input type="text" class="form-control" 
                          [(ngModel)]="state.currentContent.Subject" name="contentSubject" required>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-medium">{{ 'MANAGE_SECTIONS.LABELS.CONTENT' | translate }}*</label>
                    <textarea class="form-control" [(ngModel)]="state.currentContent.Content" 
                              name="contentText" rows="5" required></textarea>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-medium">{{ 'MANAGE_SECTIONS.LABELS.ORDER' | translate }}</label>
                    <input type="number" class="form-control" 
                          [(ngModel)]="state.currentContent.Order" name="contentOrder" min="0">
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-medium">{{ 'MANAGE_SECTIONS.LABELS.IMAGE' | translate }}</label>
                    <input type="file" class="form-control" 
                          (change)="onFileSelected($event, 'contentImage')" 
                          accept="image/*">
                    <div class="image-preview mt-2 position-relative d-inline-block" *ngIf="state.filePreviews.contentImage">
                      <img [src]="state.filePreviews.contentImage" class="img-thumbnail" style="max-height: 120px;">
                      <button class="btn btn-sm btn-danger remove-btn position-absolute top-0 end-0 m-1" (click)="removeFile('contentImage')">
                        <fa-icon [icon]="icons.trash"></fa-icon>
                      </button>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-medium">{{ 'MANAGE_SECTIONS.LABELS.VIDEO' | translate }}</label>
                    <input type="text" class="form-control" 
                          [(ngModel)]="state.currentContent.Url" name="videoUrl"
                          placeholder="YouTube/Vimeo video URL">
                    <div class="video-preview mt-2 position-relative" *ngIf="state.currentContent.Url">
                      <div class="ratio ratio-16x9">
                        <iframe [src]="getSafeVideoUrl(state.currentContent.Url)" 
                                frameborder="0" allowfullscreen></iframe>
                      </div>
                      <button class="btn btn-sm btn-danger remove-btn position-absolute top-0 end-0 m-1" 
                              (click)="state.currentContent.Url = ''">
                        <fa-icon [icon]="icons.trash"></fa-icon>
                      </button>
                    </div>
                  </div>
                  
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="IsActiveSwitch" 
                          [(ngModel)]="state.currentContent.IsActive" name="isActive">
                    <label class="form-check-label fw-medium" for="IsActiveSwitch">
                      {{ 'MANAGE_SECTIONS.LABELS.ACTIVE' | translate }}
                    </label>
                  </div>
                  
                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-secondary" (click)="cancelContentEdit()">
                      {{ 'MANAGE_SECTIONS.ACTIONS.CANCEL' | translate }}
                    </button>
                    <button type="button" class="btn btn-primary" (click)="addContent()">
                      {{ 'MANAGE_SECTIONS.ACTIONS.SAVE_CONTENT' | translate }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer bg-light px-4 py-3 mt-4">
          <div class="d-flex justify-content-between w-100 align-items-center">
            <div>
              <button type="button" class="btn btn-outline-primary me-2" 
                      (click)="prevTab()" 
                      *ngIf="state.currentTab !== 'info'"
                      [disabled]="state.isSubmitting">
                <fa-icon [icon]="icons.left" class="me-2"></fa-icon>
                {{ 'MANAGE_SECTIONS.ACTIONS.PREVIOUS' | translate }}
              </button>
              <button type="button" class="btn btn-primary" 
                      (click)="nextTab()" 
                      *ngIf="state.currentTab !== 'content'"
                      [disabled]="state.isSubmitting">
                {{ 'MANAGE_SECTIONS.ACTIONS.NEXT' | translate }}
                <fa-icon [icon]="icons.right" class="ms-2"></fa-icon>
              </button>
            </div>
            <div>
              <button type="button" class="btn btn-outline-secondary me-2" 
                      (click)="closeModal()"
                      [disabled]="state.isSubmitting">
                {{ 'MANAGE_SECTIONS.ACTIONS.CANCEL' | translate }}
              </button>
              <button type="submit" class="btn btn-success" 
                      [disabled]="sectionForm.invalid || state.isSubmitting">
                {{ (state.isEditing ? 'MANAGE_SECTIONS.ACTIONS.UPDATE' : 'MANAGE_SECTIONS.ACTIONS.SAVE') | translate }}
                <span *ngIf="state.isSubmitting" class="spinner-border spinner-border-sm ms-2"></span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </app-modal>

  <!-- Confirm Dialog -->
  <app-confirm-dialog 
    *ngIf="showConfirmDialog"
    [message]="'MANAGE_SECTIONS.CONFIRM.DELETE' | translate" 
    (confirm)="confirmDelete()"
    (cancel)="resetConfirmation()">
  </app-confirm-dialog>
</div>